{% extends "base.html" %}
{% block content %}
<div class="container py-5 text-center">
    <div class="mb-4">
        <a href="{{ url_for('edification.kids') }}" class="btn btn-outline-primary rounded-pill mb-3">
            <i class="bi bi-arrow-left me-2"></i> Voltar para Ecclesia Kids
        </a>
        <h1 class="fw-bold text-primary">Quebra-Cabeça Bíblico</h1>
        <p class="text-muted">Escolha a dificuldade e monte a imagem!</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                <div class="row g-3 align-items-center mb-4">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">DIFICULDADE</label>
                        <select id="difficulty" class="form-select bg-light border-0 rounded-pill">
                            <option value="3">Fácil (3x3)</option>
                            <option value="4" selected>Médio (4x4)</option>
                            <option value="5">Difícil (5x5)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">IMAGEM</label>
                        <select id="image-select" class="form-select bg-light border-0 rounded-pill">
                            <option value="https://picsum.photos/512/512?random=1" selected>Imagem de Teste 1 (Picsum)</option>
                            <option value="https://picsum.photos/512/512?random=2">Imagem de Teste 2</option>
                            <option value="https://picsum.photos/512/512?random=3">Imagem de Teste 3</option>
                            <!--<option value="https://bibleforchildren.org/images/portuguese/01/1.jpg">Criação</option>
                            <option value="https://bibleforchildren.org/images/portuguese/02/1.jpg">Arca de Noé</option>
                            <option value="https://bibleforchildren.org/images/portuguese/48/1.jpg">Nascimento de Jesus</option>-->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button onclick="initPuzzle()" class="btn btn-primary w-100 fw-bold rounded-pill mt-3">
                            <i class="bi bi-play-fill me-1"></i> Novo Jogo
                        </button>
                    </div>
                </div>

                <div id="puzzle-container" class="mx-auto position-relative" style="width: 400px; height: 400px; background: #f8f9fa; border: 2px dashed #dee2e6;">
                    <!-- Puzzle pieces will be here -->
                </div>

                <div id="victory-msg" class="mt-4 alert alert-success d-none rounded-pill fw-bold">
                    <i class="bi bi-trophy-fill me-2"></i> Parabéns! Você montou o quebra-cabeça!
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .puzzle-piece {
        position: absolute;
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.3);
        box-sizing: border-box;
        transition: transform 0.2s;
    }
    .puzzle-piece:hover {
        z-index: 100;
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .puzzle-piece.correct {
        border: none;
        pointer-events: none;
    }
</style>

<script>
let size = 4;
let imageUrl = '';
let pieces = [];
const container = document.getElementById('puzzle-container');
const victoryMsg = document.getElementById('victory-msg');

// Variáveis globais para drag (eventos únicos no document)
let currentPiece = null;
let isDragging = false;
let startX = 0;
let startY = 0;

// Eventos globais (definidos só uma vez)
document.onmousemove = (e) => {
    if (!isDragging || !currentPiece) return;
    
    let x = e.clientX - startX;
    let y = e.clientY - startY;
    
    x = Math.max(0, Math.min(x, 400 - currentPiece.offsetWidth));
    y = Math.max(0, Math.min(y, 400 - currentPiece.offsetHeight));
    
    currentPiece.style.left = `${x}px`;
    currentPiece.style.top = `${y}px`;
};

document.onmouseup = () => {
    if (!isDragging || !currentPiece) return;
    isDragging = false;
    currentPiece.style.zIndex = '';
    checkPosition(currentPiece);
    currentPiece = null;
};

// Touch global (para celular)
document.ontouchmove = (e) => {
    if (!isDragging || !currentPiece) return;
    const touch = e.touches[0];
    let x = touch.clientX - startX;
    let y = touch.clientY - startY;
    
    x = Math.max(0, Math.min(x, 400 - currentPiece.offsetWidth));
    y = Math.max(0, Math.min(y, 400 - currentPiece.offsetHeight));
    
    currentPiece.style.left = `${x}px`;
    currentPiece.style.top = `${y}px`;
    e.preventDefault();
};

document.ontouchend = () => {
    if (!isDragging || !currentPiece) return;
    isDragging = false;
    currentPiece.style.zIndex = '';
    checkPosition(currentPiece);
    currentPiece = null;
};

function initPuzzle() {
    size = parseInt(document.getElementById('difficulty').value) || 4;
    imageUrl = document.getElementById('image-select').value || 'https://picsum.photos/512/512?random=1';

    container.innerHTML = '';
    victoryMsg.classList.add('d-none');
    
    const containerSize = 400;
    const pieceSize = containerSize / size;
    pieces = [];

    if (!imageUrl) {
        container.innerHTML = '<p class="text-danger mt-5">Selecione uma imagem válida!</p>';
        return;
    }

    for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
            const piece = document.createElement('div');
            piece.className = 'puzzle-piece';
            piece.style.width = `${pieceSize}px`;
            piece.style.height = `${pieceSize}px`;
            piece.style.backgroundImage = `url(${imageUrl})`;
            piece.style.backgroundSize = `${containerSize}px ${containerSize}px`;
            piece.style.backgroundPosition = `-${c * pieceSize}px -${r * pieceSize}px`;
            
            piece.dataset.correctX = c * pieceSize;
            piece.dataset.correctY = r * pieceSize;
            
            const startX = Math.random() * (containerSize - pieceSize);
            const startY = Math.random() * (containerSize - pieceSize);
            piece.style.left = `${startX}px`;
            piece.style.top = `${startY}px`;
            
            // Drag com mouse
            piece.onmousedown = (e) => {
                isDragging = true;
                currentPiece = piece;
                startX = e.clientX - piece.offsetLeft;
                startY = e.clientY - piece.offsetTop;
                piece.style.zIndex = 1000;
                e.preventDefault();
            };

            // Drag com touch
            piece.ontouchstart = (e) => {
                isDragging = true;
                currentPiece = piece;
                const touch = e.touches[0];
                startX = touch.clientX - piece.offsetLeft;
                startY = touch.clientY - piece.offsetTop;
                piece.style.zIndex = 1000;
                e.preventDefault();
            };
            
            container.appendChild(piece);
            pieces.push(piece);
        }
    }
    
    console.log("Puzzle iniciado com imagem:", imageUrl);
}

function checkPosition(el) {
    const curX = parseFloat(el.style.left) || 0;
    const curY = parseFloat(el.style.top) || 0;
    const corX = parseFloat(el.dataset.correctX);
    const corY = parseFloat(el.dataset.correctY);
    
    const threshold = 20;
    if (Math.abs(curX - corX) < threshold && Math.abs(curY - corY) < threshold) {
        el.style.left = `${corX}px`;
        el.style.top = `${corY}px`;
        el.classList.add('correct');
        el.style.cursor = 'default';
        checkVictory();
    }
}

function checkVictory() {
    const allCorrect = pieces.every(p => p.classList.contains('correct'));
    if (allCorrect) {
        victoryMsg.classList.remove('d-none');
        victoryMsg.scrollIntoView({ behavior: 'smooth' });
    }
}

// Eventos
document.getElementById('difficulty').addEventListener('change', initPuzzle);
document.getElementById('image-select').addEventListener('change', initPuzzle);
document.querySelector('button[onclick="initPuzzle()"]').addEventListener('click', initPuzzle);

// Inicializa na carga
document.addEventListener('DOMContentLoaded', initPuzzle);
</script>
{% endblock %}