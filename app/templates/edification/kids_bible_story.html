{% extends "base.html" %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('edification.kids') }}">Ecclesia Kids</a></li>
                    <li class="breadcrumb-item active">{{ story.title }}</li>
                </ol>
            </nav>

            <div class="card border-0 shadow-sm overflow-hidden rounded-4 mb-5">
                {% if story.image_path %}
                <img src="{{ story.image_path }}" class="card-img-top" alt="{{ story.title }}" style="max-height: 400px; object-fit: cover;">
                {% else %}
                <div class="bg-warning bg-opacity-10 text-center py-5">
                    <i class="bi bi-book-half display-1 text-warning opacity-50"></i>
                </div>
                {% endif %}
                
                <div class="card-body p-4 p-md-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="fw-bold text-warning mb-0">{{ story.title }}</h1>
                        <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill">{{ story.reference }}</span>
                    </div>
                    
                    <div class="story-content fs-5 text-muted lh-lg mb-5">
                        {{ story.content | safe }}
                    </div>

                    <hr class="my-5 opacity-10">

                    <!-- Seção de Quiz -->
                    {% if story.quizzes %}
                    <div id="quiz-section">
                        <h3 class="fw-bold mb-4 text-dark"><i class="bi bi-patch-question me-2 text-warning"></i>O que você aprendeu?</h3>
                        
                        {% for quiz in story.quizzes %}
                        <div class="quiz-card mb-4 p-4 border rounded-4 bg-light bg-opacity-50" id="quiz-{{ quiz.id }}">
                            <p class="fw-bold fs-5 mb-4">{{ loop.index }}. {{ quiz.question }}</p>
                            
                            <div class="d-grid gap-3">
                                <button class="btn btn-outline-dark text-start p-3 rounded-3 quiz-option" onclick="checkAnswer('{{ quiz.id }}', 'A', '{{ quiz.correct_option }}', '{{ quiz.explanation }}')">
                                    <span class="fw-bold me-2">A)</span> {{ quiz.option_a }}
                                </button>
                                <button class="btn btn-outline-dark text-start p-3 rounded-3 quiz-option" onclick="checkAnswer('{{ quiz.id }}', 'B', '{{ quiz.correct_option }}', '{{ quiz.explanation }}')">
                                    <span class="fw-bold me-2">B)</span> {{ quiz.option_b }}
                                </button>
                                <button class="btn btn-outline-dark text-start p-3 rounded-3 quiz-option" onclick="checkAnswer('{{ quiz.id }}', 'C', '{{ quiz.correct_option }}', '{{ quiz.explanation }}')">
                                    <span class="fw-bold me-2">C)</span> {{ quiz.option_c }}
                                </button>
                            </div>
                            
                            <div class="mt-4 d-none feedback-area p-3 rounded-3">
                                <p class="mb-0 fw-bold feedback-text"></p>
                                <p class="small mb-0 mt-2 explanation-text"></p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.story-content p {
    margin-bottom: 1.5rem;
}
.quiz-option {
    transition: all 0.2s ease;
    border-width: 2px;
}
.quiz-option:hover {
    background-color: #fff;
    border-color: #ffc107;
}
.correct-answer {
    background-color: #d1e7dd !important;
    border-color: #0f5132 !important;
    color: #0f5132 !important;
}
.wrong-answer {
    background-color: #f8d7da !important;
    border-color: #842029 !important;
    color: #842029 !important;
}
</style>

<script>
function checkAnswer(quizId, selected, correct, explanation) {
    const card = document.getElementById('quiz-' + quizId);
    const options = card.querySelectorAll('.quiz-option');
    const feedback = card.querySelector('.feedback-area');
    const feedbackText = card.querySelector('.feedback-text');
    const explanationText = card.querySelector('.explanation-text');
    
    // Desabilitar opções
    options.forEach(opt => opt.disabled = true);
    
    feedback.classList.remove('d-none');
    
    if (selected === correct) {
        feedback.classList.add('bg-success', 'bg-opacity-10', 'text-success');
        feedbackText.innerHTML = '✨ Parabéns! Você acertou!';
        explanationText.innerText = explanation;
        
        // Destacar a correta
        options.forEach(opt => {
            if (opt.innerText.trim().startsWith(selected)) {
                opt.classList.add('correct-answer');
            }
        });
    } else {
        feedback.classList.add('bg-danger', 'bg-opacity-10', 'text-danger');
        feedbackText.innerHTML = '❌ Quase lá! Tente prestar atenção na próxima.';
        explanationText.innerText = 'A resposta correta era a ' + correct + '.';
        
        // Destacar a selecionada errada e a correta
        options.forEach(opt => {
            if (opt.innerText.trim().startsWith(selected)) {
                opt.classList.add('wrong-answer');
            }
            if (opt.innerText.trim().startsWith(correct)) {
                opt.classList.add('correct-answer');
            }
        });
    }
}
</script>
{% endblock %}
